<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>光之乐团问题V3谱面转换工具</title>
    <script src="https://cdn.staticfile.org/jszip/3.6.0/jszip.min.js"></script>
</head>
<body>
    <h2>光之乐团问题谱面转换工具</h2>
    <p>此工具用于处理光之乐团的问题V3谱面。上传旧谱面，并将生成的新谱面导入光之乐团即可。</p>
    <p>说明：部分谱面在光之乐团中箭头的方向出错，导致出现大量同向箭头。问题产生的原因是，由于原始谱面文件追求更小的文件大小，对于默认方向（向上，d=0）的note省略了对于方向的定义，而光之乐团中的默认方向与BS相反，会导致原先向上的箭头变为向下。使用本工具可以生成与bs中方向一致的谱面文件</p>
    <p>问题谱面特点：</br>1.通常为V3谱面（并不是V3谱面都有问题，只有少数）</br>2.谱面完全没有向上箭头，但有大量向下箭头（不包含斜向箭头）。</p>
    <p>2024/1/13 更新sliders、burstSliders处理逻辑</p>
    <p>by 舞剑不说话</p>

    <h3>处理ZIP文件中的谱面</h3>
    <input type="file" id="fileInput" accept=".zip">
    <button id="processZipBtn" onclick="processSelectedFile()">处理ZIP文件</button>

    <h3>处理单个难度(.dat)文件</h3>
    <input type="file" id="singleDatInput" accept=".dat">
    <button id="processDatBtn" onclick="processSelectedDat()">处理DAT文件</button>

    <script>
        function processJsonData(jsonData) {
            // 创建一个通用的处理函数
            function addDefaultDirection(notes) {
                if (Array.isArray(notes)) {
                    notes.forEach(note => {
                        if (note.d === undefined) {
                            note.d = 0;
                        }
                    });
                }
            }
    
            // 对 colorNotes, sliders, burstSliders 应用通用处理函数
            addDefaultDirection(jsonData.colorNotes);
            addDefaultDirection(jsonData.sliders);
            addDefaultDirection(jsonData.burstSliders);
    
            return jsonData;
        }

        function processSelectedFile() {
            let fileInput = document.getElementById('fileInput');
            if (!fileInput.files.length) {
                alert('请先选择一个ZIP文件。');
                return;
            }
            processZipFile(fileInput.files[0]);
        }

        function processZipFile(file) {
            JSZip.loadAsync(file)
                .then(zip => {
                    let promises = [];
                    let outputFileName = file.name.replace(/\.zip$/, '') + '_fixed.zip';

                    Object.keys(zip.files).forEach(fileName => {
                        if (fileName.endsWith('.dat')) {
                            let promise = zip.files[fileName].async('string')
                                .then(content => {
                                    try {
                                        let jsonData = JSON.parse(content);
                                        if (jsonData.colorNotes && Array.isArray(jsonData.colorNotes)) {
                                            jsonData = processJsonData(jsonData); 
                                            zip.file(fileName, JSON.stringify(jsonData, null, 4));
                                        }
                                    } catch (e) {
                                        console.error('处理文件出错:', fileName, e);
                                    }
                                });
                            promises.push(promise);
                        }
                    });

                    Promise.all(promises).then(() => {
                        zip.generateAsync({type: "blob"})
                            .then(blob => downloadBlob(blob, outputFileName))
                            .catch(e => console.error('生成ZIP文件出错:', e));
                    })
                    .catch(e => console.error('处理文件出错:', e));
                })
                .catch(e => console.error('加载ZIP文件出错:', e));
        }

        function processSelectedDat() {
            let fileInput = document.getElementById('singleDatInput');
            if (!fileInput.files.length) {
                alert('请先选择一个DAT文件。');
                return;
            }
            processDatFile(fileInput.files[0]);
        }

        function processDatFile(file) {
            let reader = new FileReader();
            reader.onload = function(event) {
                try {
                    let jsonData = JSON.parse(event.target.result);
                    if (jsonData.colorNotes && Array.isArray(jsonData.colorNotes)) {
                        jsonData.colorNotes.forEach(note => {
                            jsonData = processJsonData(jsonData); 
                        });
                        downloadBlob(new Blob([JSON.stringify(jsonData, null, 4)], {type: "application/json"}), file.name);
                    }
                } catch (e) {
                    console.error('处理DAT文件出错:', e);
                    alert('DAT文件格式不正确或已损坏。');
                }
            };
            reader.readAsText(file);
        }

        function downloadBlob(blob, fileName) {
            const url = window.URL.createObjectURL(blob);
            const anchor = document.createElement('a');
            anchor.href = url;
            anchor.download = fileName;
            anchor.click();
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
